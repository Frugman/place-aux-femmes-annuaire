<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rejoindre l'Annuaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-lg border border-gray-200" id="formContainer">
        <h1 class="text-2xl font-bold text-indigo-700 mb-6 text-center">Rejoindre la Communaut√© ‚ú®</h1>
        
        <form id="joinForm" class="space-y-4">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Pr√©nom</label>
                    <input type="text" id="prenom" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" id="nom" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Intitul√© du poste / Expertise</label>
                <input type="text" id="job" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Ville</label>
                <div class="flex gap-2">
                    <input type="text" id="ville" placeholder="Ex: Lyon" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                    <button type="button" onclick="findGPS()" class="mt-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">üìç Localiser</button>
                </div>
                <p id="gps-status" class="text-xs text-gray-500 mt-1">Clique sur "Localiser" pour valider.</p>
                <input type="hidden" id="lat">
                <input type="hidden" id="lng">
            </div>

            <div class="pt-4">
                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700 transition disabled:opacity-50">
                    Valider mon inscription
                </button>
            </div>
            <p id="message" class="text-center text-sm mt-4 font-bold hidden"></p>
        </form>
    </div>

    <div id="successScreen" class="hidden bg-white p-8 rounded-lg shadow-md w-full max-w-lg border border-green-200 text-center">
        <div class="text-5xl mb-4">üéâ</div>
        <h2 class="text-2xl font-bold text-green-700 mb-2">Inscription r√©ussie !</h2>
        <p class="text-gray-600">Ta fiche a √©t√© cr√©√©e. Elle appara√Ætra sur la carte d'ici 2 √† 3 minutes (le temps que le site se mette √† jour).</p>
        <a href="index.html" class="block mt-6 text-indigo-600 underline">Retour √† la carte</a>
    </div>

    <script>
        // Recherche GPS
        async function findGPS() {
            const ville = document.getElementById('ville').value;
            const status = document.getElementById('gps-status');
            if(!ville) { status.innerText = "‚ö†Ô∏è Entre une ville d'abord."; return; }
            status.innerText = "üîç Recherche...";
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ville)}`);
                const data = await response.json();
                if(data && data.length > 0) {
                    document.getElementById('lat').value = data[0].lat;
                    document.getElementById('lng').value = data[0].lon;
                    status.innerText = `‚úÖ Trouv√© : ${data[0].display_name}`;
                    status.classList.add('text-green-600');
                } else { status.innerText = "‚ùå Ville introuvable."; }
            } catch (e) { status.innerText = "‚ùå Erreur de connexion."; }
        }

        // Envoi vers Vercel
        document.getElementById('joinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('message');
            const lat = document.getElementById('lat').value;

            if(!lat) { alert("Clique sur 'Localiser' avant de valider !"); return; }

            btn.disabled = true;
            btn.innerText = "Envoi en cours...";

            const data = {
                prenom: document.getElementById('prenom').value,
                nom: document.getElementById('nom').value,
                job: document.getElementById('job').value,
                ville: document.getElementById('ville').value,
                lat: document.getElementById('lat').value,
                lng: document.getElementById('lng').value,
                photo: `https://ui-avatars.com/api/?name=${document.getElementById('prenom').value}+${document.getElementById('nom').value}&background=random`
            };

            try {
                const response = await fetch('/api/inscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('formContainer').classList.add('hidden');
                    document.getElementById('successScreen').classList.remove('hidden');
                } else {
                    const error = await response.json();
                    msg.innerText = "Erreur : " + (error.details ? JSON.stringify(error.details) : error.error);
                    msg.classList.remove('hidden', 'text-green-600');
                    msg.classList.add('text-red-600');
                    btn.disabled = false;
                }
            } catch (err) {
                msg.innerText = "Erreur de connexion.";
                msg.classList.remove('hidden');
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
